#!/bin/bash
USAGE="Usage: $0 MASTER_IP IP2 IP3 ..."

if [ "$#" == "0" ]; then
	echo "$USAGE"
	exit 1
fi

MASTER="$1"
NODE_NAME="cassandra-node"
VOLUME_PATH="/home/student/cassandra-data"

CASSANDRA_PORT=4321

while (( "$#" )); do
    
    if [ "$1" = "$MASTER" ]; 
    then
        COMMAND="docker run --name $NODE_NAME -d -e CASSANDRA_BROADCAST_ADDRESS=$1 -p 7000:7000 -p $CASSANDRA_PORT:9042 -v $VOLUME_PATH:/var/lib/cassandra cassandra"
    else
        COMMAND="docker run --name $NODE_NAME -d -e CASSANDRA_BROADCAST_ADDRESS=$1 -p 7000:7000 -p $CASSANDRA_PORT:9042 -e CASSANDRA_SEEDS=$MASTER -v $VOLUME_PATH:/var/lib/cassandra cassandra"
    fi
    ssh student@$1 "docker container stop $NODE_NAME; docker container rm $NODE_NAME; if [ ! -d $VOLUME_PATH ]; then mkdir -p $VOLUME_PATH; fi; $COMMAND;"
    
    while true;
    do
        sleep 5
		STATUS=$(docker exec -it $NODE_NAME nodetool status | grep -e $1)
        STATUSUN=$(echo $STATUS | grep -e "UN")
        echo $STATUS
        [[ ! -z "$STATUSUN" ]] && break;
    done;
    shift
done

KEYSPACE_EXISTS=$(ssh student@$MASTER "docker exec $NODE_NAME cqlsh -e \"DESCRIBE KEYSPACES;\"" | grep -e "url_shortener")
if [ -z "$KEYSPACE_EXISTS" ]; then
ssh student@$MASTER "docker exec $NODE_NAME cqlsh -e \"CREATE KEYSPACE url_shortener WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 2} ; USE url_shortener; CREATE TABLE IF NOT EXISTS urls (short_code text PRIMARY KEY, url_original text);\""
# ssh student@10.128.1.28 "docker exec cassandra-node cqlsh -e \"CREATE KEYSPACE url_shortener WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 2} ; USE url_shortener; CREATE TABLE IF NOT EXISTS urls (short_code text PRIMARY KEY, url_original text);\""
fi

# docker exec -it cassandra-node bash -c "nodetool status"

docker exec cassandra-node cqlsh -e "DESCRIBE KEYSPACES;"
docker exec -it cassandra-node cqlsh

# Example commands

# USE url_shortener;
# INSERT INTO urls (short_code, url_original) VALUES ('abc', 'https://www.google.com');
# SELECT * FROM urls WHERE short_code = 'abc' ALLOW FILTERING;
# SELECT * FROM url_shortener.urls;
